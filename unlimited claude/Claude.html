<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAUDE EN ESPA√ëOL</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background-color: #1a1a1a;
            color: #e5e5e5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: #262626;
            border-right: 1px solid #404040;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #404040;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 16px;
        }

        .back-arrow {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: #ff6b35;
            font-size: 14px;
            padding: 8px 0;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .new-chat-btn:hover {
            opacity: 0.8;
        }

        .plus-icon {
            width: 16px;
            height: 16px;
            background-color: #ff6b35;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }

        .sidebar-nav {
            padding: 16px;
            border-bottom: 1px solid #404040;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            color: #b3b3b3;
            font-size: 14px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item:hover {
            color: #fff;
        }

        .nav-icon {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .sidebar-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 12px;
            color: #808080;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recent-items {
            min-height: 20px;
        }

        /* fila de conversaci√≥n reciente */
        .recent-item {
            padding: 6px 0;
            color: #b3b3b3;
            font-size: 13px;
            line-height: 1.4;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        /* t√≠tulo clickable */
        .recent-item-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .recent-item-title:hover {
            color: #fff;
        }

        /* bot√≥n de borrar una conversaci√≥n */
        .recent-item-delete {
            border: none;
            background: transparent;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .recent-item-delete:hover {
            background-color: #333;
            color: #ff7b73;
        }

        .empty-state {
        padding: 8px 0;
        text-align: center;
       }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid #404040;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .user-avatar {
        width: 24px;
        height: 24px;
        background-color: #f09711;   /* mismo color que el icono de borrar */
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        color: white;
        }

        /* imagen dentro del avatar */
        .user-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: contain;        /* ajusta la imagen sin deformarla */
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-size: 14px;
            color: #fff;
            font-weight: 500;
        }

        .user-plan {
            font-size: 12px;
            color: #808080;
        }

        .chevron-down {
            width: 16px;
            height: 16px;
            opacity: 0.5;
        }

        /* Contenido principal */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1a1a1a;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 40px;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            margin-bottom: 20px;
            height: calc(100vh - 200px);
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: #404040 #262626;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #262626;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .message {
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background-color: #ff6b35;
            color: white;
        }

        .message.assistant .message-avatar {
            background-color: #4a90e2;
            color: white;
        }

        .message-content {
            max-width: 70%;
            background-color: #262626;
            border-radius: 12px;
            padding: 16px;
            color: #e5e5e5;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
        .message.assistant .message-content {
            padding: 0; /* Remove padding for container of artifacts */
        }
        .message-text-part {
            padding: 16px;
            white-space: pre-wrap;
        }

        .message.user .message-content {
            background-color: #ff6b35;
            color: white;
            padding: 16px; /* Restore padding for user messages */
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #808080;
            font-style: italic;
            padding: 16px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #808080;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .greeting {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
            font-size: 32px;
            font-weight: 400;
            color: #fff;
        }

        .sun-icon {
            width: 32px;
            height: 32px;
            color: #ff6b35;
        }

        .search-container {
            width: 100%;
            max-width: 600px;
            position: relative;
            margin-bottom: 20px;
        }

        .chat-container .search-container {
            position: sticky;
            bottom: 0;
            background-color: #1a1a1a;
            padding: 20px 0;
            margin: 0;
            max-width: none;
        }

        .search-input {
            width: 100%;
            padding: 16px 120px 16px 16px;
            background-color: #262626;
            border: 1px solid #404040;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            font-family: inherit;
        }

        .search-input:focus {
            border-color: #ff6b35;
        }

        .search-input::placeholder {
            color: #808080;
        }

        .search-actions {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 4px;
        }

        .search-btn {
            padding: 8px;
            background: none;
            border: none;
            color: #808080;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .search-btn:hover {
            background-color: #404040;
        }

        .send-btn {
            padding: 8px;
            background-color: #ff6b35;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background-color: #e55a2b;
        }

        .send-btn:disabled {
            background-color: #404040;
            cursor: not-allowed;
        }

        .model-selector {
            align-self: flex-end;
            margin-bottom: 20px;
            margin-right: 60px;
        }

        .model-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: #b3b3b3;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .model-btn:hover {
            background-color: #262626;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background-color: #262626;
            border: 1px solid #404040;
            border-radius: 8px;
            color: #e5e5e5;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .action-btn:hover {
            background-color: #333;
            border-color: #555;
            transform: translateY(-1px);
        }

        .action-icon {
            width: 16px;
            height: 16px;
            opacity: 0.8;
        }
        
        /* Estilos de lienzo de artefactos */
        .artifact-canvas {
            background-color: #0d0d0d;
            border: 1px solid #404040;
            border-radius: 8px;
            margin: 16px;
            overflow: hidden;
        }

        .artifact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #2a2a2a;
            padding: 8px 12px;
            border-bottom: 1px solid #404040;
        }

        .artifact-title {
            font-size: 13px;
            font-weight: 500;
            color: #b3b3b3;
        }

        .artifact-actions {
            display: flex;
            gap: 8px;
        }

        .artifact-btn {
            background: none;
            border: 1px solid #555;
            color: #b3b3b3;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .artifact-btn:hover {
            background-color: #404040;
            color: #fff;
        }
        
        .artifact-btn.view-btn {
            border-color: #4a90e2;
            color: #4a90e2;
        }
        .artifact-btn.view-btn:hover {
            background-color: #4a90e2;
            color: #fff;
        }

        .artifact-btn svg {
            width: 14px;
            height: 14px;
        }

        .artifact-code {
            padding: 12px;
            max-height: 400px;
            overflow: auto;
            scrollbar-width: thin;
            scrollbar-color: #404040 #1a1a1a;
        }
        
        .artifact-code pre {
            margin: 0;
        }

        .artifact-code code {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            color: #e5e5e5;
            white-space: pre;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
            }
            
            .greeting {
                font-size: 24px;
            }
            
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .action-btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    Claude Local
                </div>
                <button class="new-chat-btn" id="newChatBtn">
                    <div class="plus-icon">+</div>
                    Nuevo chat
                </button>
            </div>

            
            <div class="sidebar-content">
                <div class="section-title">Chats</div>
                <div class="recent-items" id="recentItems">
                    <div class="empty-state" id="emptyState">
                        <span style="color: #666; font-size: 13px; font-style: italic;">No hay conversaciones recientes</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <button id="clearHistoryBtn" class="new-chat-btn" style="justify-content:flex-start; margin-bottom:10px; color:#f97373;">
                    <div class="plus-icon" style="background-color:#f09711;">üóë</div>
                    Borrar chats
                </button>
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <div class="user-details">

                        <div class="user-name">Usuario</div>
                        <div class="user-plan">Local</div>
                    </div>
                    <svg class="chevron-down" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </div>

            </div>
        </div>
        
        <!-- Contenido principal -->
        <div class="main-content">
            <div class="content-area">
                <!-- Pantalla de bienvenida -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="greeting">
                        <img src="logo-dupavi-es.webp" alt="Logo dupavi.es" class="sun-icon">
                        Buenos d√≠as desde dupavi.es
                    </div>

                    
                    <div class="search-container">
                        <textarea class="search-input" id="welcomeInput" placeholder="¬øC√≥mo puedo ayudarte hoy?" rows="1"></textarea>
                        <div class="search-actions">
                            <button class="search-btn" id="researchBtn">Investigaci√≥n</button>
                            <button class="send-btn" id="sendBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div style="max-width: 600px; margin-bottom: 15px; padding: 12px; background-color: #2a2a2a; border-radius: 8px; border: 1px solid #404040;">
                        <div style="font-size: 13px; color: #b3b3b3; text-align: center; margin-bottom: 10px;">
                            üí° <strong>¬øPrimera vez?</strong> Aparecer√° una peque√±a ventana emergente para la autenticaci√≥n: perm√≠tela para habilitar el acceso gratuito de Claude a trav√©s de Puter.js
                        </div>
                        <div style="font-size: 12px; color: #808080; text-align: center; margin-bottom: 10px;" id="protocolNotice">
                            <!-- This will be populated by JS -->
                        </div>
                        <div style="text-align: center;">
                            <button id="authButton" style="background-color: #ff6b35; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                üîê Autenticarse con Pute
                            </button>
                        </div>
                    </div>
                    
                    <div class="model-selector">
                        <button class="model-btn" id="modelSelector">
                            <span id="currentModel">Claude Sonnet 4</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn" data-prompt="Ay√∫dame a escribir">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                            Escribir
                        </button>
                        <button class="action-btn" data-prompt="Ens√©√±ame sobre">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6L23 9l-11-6zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/>
                            </svg>
                            Aprender
                        </button>
                        <button class="action-btn" data-prompt="Ay√∫dame a codificar">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                            </svg>
                            C√≥digo
                        </button>
                        <button class="action-btn" data-prompt="Ay√∫dame con las tareas diarias">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            Cosas de la vida
                        </button>
                        <button class="action-btn" data-prompt="Ay√∫dame a conectar mis aplicaciones">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H6.99C4.79 7 3 8.79 3 11s1.79 4 4 4H11v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4.01c2.2 0 4-1.79 4-4s-1.8-4-4.01-4z"/>
                            </svg>
                            Conectar aplicaciones
                        </button>
                    </div>
                </div>

                <!-- Chat Container -->
                <div class="chat-container" id="chatContainer">
                    <div class="chat-messages" id="chatMessages"></div>
                    
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="message-avatar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <span>Claude est√° escribiendo</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                    
                    <div class="search-container">
                        <textarea class="search-input" id="chatInput" placeholder="Message Claude..." rows="1"></textarea>
                        <div class="search-actions">
                            <button class="model-btn" id="chatModelSelector" style="padding: 6px 8px; font-size: 12px;">
                                <span id="chatCurrentModel">Sonnet 4</span>
                            </button>
                            <button class="send-btn" id="chatSendBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado global
        const availableModels = [
            { apiName: 'claude-sonnet-4', displayName: 'Claude Sonnet 4', shortName: 'Sonnet 4' },
            { apiName: 'claude-opus-4', displayName: 'Claude Opus 4', shortName: 'Opus 4' },
            { apiName: 'claude-3-7-sonnet', displayName: 'Claude 3.7 Sonnet', shortName: 'Sonnet 3.7' }
        ];
        let currentModel = availableModels[0].apiName;
        let chatHistory = [];
        let isStreaming = false;
        let recentConversations = [];
        let currentConversationId = null;

        const STORAGE_KEY = 'claude-local-es-state-v1';

        function saveState() {
            try {
                const state = {
                    recentConversations,
                    currentConversationId,
                    currentModel
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.error('Error guardando el estado:', e);
            }
        }

        function loadState() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const state = JSON.parse(raw);

                if (Array.isArray(state.recentConversations)) {
                    recentConversations = state.recentConversations;
                }

                if (
                    state.currentModel &&
                    availableModels.some(m => m.apiName === state.currentModel)
                ) {
                    currentModel = state.currentModel;
                }

                if (state.currentConversationId) {
                    currentConversationId = state.currentConversationId;
                    const conv = recentConversations.find(c => c.id === currentConversationId);
                    if (conv) {
                        chatHistory = conv.messages || [];
                    }
                }
            } catch (e) {
                console.error('Error cargando el estado:', e);
            }
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Claude interface...');
            loadState();               // üî∏ Cargar historial guardado
            initializeInterface();
            updateModelDisplay();
            updateProtocolNotice();
            updateRecentItems();       // üî∏ Pintar lista de recientes

            // Si hab√≠a una conversaci√≥n activa, la mostramos
            if (chatHistory.length > 0) {
                switchToChatView();
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.innerHTML = '';
                    chatHistory.forEach(msg => {
                        addMessage(msg.content, msg.role);
                    });
                }
            }
        });

        function updateProtocolNotice() {
            const protocolNotice = document.getElementById('protocolNotice');
            if (protocolNotice) {
                if (window.location.protocol === 'file:') {
                    protocolNotice.innerHTML = '‚úÖ <strong>Modo de archivo:</strong> ¬°La autenticaci√≥n deber√≠a funcionar perfectamente aqu√≠!';
                    protocolNotice.style.color = '#22c55e';
                } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    protocolNotice.innerHTML = '‚ö†Ô∏è <strong>Modo servidor:</strong> Si la autenticaci√≥n falla, es probable que haya problemas con el perfil del navegador. Consulta la gu√≠a a continuaci√≥n.';
                    protocolNotice.style.color = '#f59e0b';
                } else {
                    protocolNotice.innerHTML = 'üåê <strong>Modo web:</strong> Aseg√∫rese de que las ventanas emergentes est√©n permitidas para este dominio.';
                    protocolNotice.style.color = '#3b82f6';
                }
            }
        }

        async function handleManualAuth() {
            const authButton = document.getElementById('authButton');
            
            try {
                if (authButton) {
                    authButton.textContent = 'üîÑ Autenticando...';
                    authButton.disabled = true;
                }
                
                console.log('üîê Activando manualmente la autenticaci√≥n del ordenador...');
                
                // Activar la autenticaci√≥n con una simple llamada de prueba
                const authResponse = await puter.ai.chat("test", {model: 'claude-sonnet-4'});
                
                console.log('‚úÖ Raw auth response:', authResponse);

                // Compruebe si la estructura de respuesta es correcta
                if (authResponse && (authResponse.message?.content || authResponse.success !== false)) {
                     console.log('‚úÖ ¬°Autenticaci√≥n exitosa!');
                    if (authButton) {
                        authButton.textContent = '‚úÖ Autenticado';
                        authButton.style.backgroundColor = '#22c55e';
                        setTimeout(() => {
                           const authBox = authButton.closest('div[style*="max-width: 600px"]');
                           if(authBox) authBox.style.display = 'none';
                        }, 2000);
                    }
                } else {
                    throw new Error('La respuesta de autenticaci√≥n indica falla.');
                }
                
            } catch (error) {
                console.error('‚ùå La autenticaci√≥n manual fall√≥:', error);
                
                if (authButton) {
                    authButton.textContent = '‚ùå Error de autenticaci√≥n - Gu√≠a de prueba';
                    authButton.disabled = false;
                    authButton.style.backgroundColor = '#dc2626';
                }
                
                // --- MENSAJE DE ERROR MEJORADO ---
                const troubleshootGuide = `
‚ö†Ô∏è ¬°FALL√ì LA AUTENTICACI√ìN!

Esto generalmente sucede debido a la configuraci√≥n del perfil de su navegador (extensiones, cach√©, etc.), NO a un error en el c√≥digo.

Como habr√°s notado, funciona en un nuevo perfil de Invitado o Inc√≥gnito. Aqu√≠ te explicamos c√≥mo solucionarlo en tu perfil PRINCIPAL:

--- GU√çA DE SOLUCI√ìN DE PROBLEMAS ---

‚úÖ LA SOLUCI√ìN M√ÅS R√ÅPIDA (INT√âNTALO PRIMERO):
1.  ü•∑ Usar el modo inc√≥gnito/privado:
    ‚Ä¢ Presione Ctrl+Shift+N (Chrome/Edge) o Ctrl+Shift+P (Firefox).
    ‚Ä¢ Abra este archivo HTML. Esta es la soluci√≥n m√°s r√°pida.

üîß PARA ARREGLAR TU PERFIL PRINCIPAL (INT√âNTALO EN ORDEN):
2.  üîå Deshabilitar extensiones:
    ‚Ä¢ Vaya a la p√°gina de extensiones de su navegador (por ejemplo, chrome://extensions).
    ‚Ä¢ Desactive TEMPORALMENTE TODAS las extensiones, especialmente los bloqueadores de anuncios (uBlock, AdBlock) y los bloqueadores de privacidad.
    ‚Ä¢ Actualice esta p√°gina e intente autenticarse nuevamente.

3.  üßπ Borrar datos del sitio para la computadora:
    ‚Ä¢ Vaya a puter.com, haga clic en el √≠cono üîí en la barra de direcciones -> Configuraci√≥n del sitio/Cookies y datos del sitio -> Eliminar datos.
    ‚Ä¢ Actualice esta p√°gina e int√©ntelo nuevamente.

4.  üç™ Permitir cookies de terceros:
    ‚Ä¢ Vaya a la configuraci√≥n de cookies de su navegador (por ejemplo, chrome://settings/cookies).
    ‚Ä¢ Aseg√∫rese de que "Bloquear cookies de terceros" NO est√© habilitado o agregue "[*.]puter.com" a la lista de permitidos.

Si est√° ejecutando esto desde un servidor local (como localhost), el problema casi seguramente est√© en las extensiones o en la configuraci√≥n de cookies.
`;
                alert(troubleshootGuide);
            }
        }

        function initializeInterface() {
            const welcomeInput = document.getElementById('welcomeInput');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const newChatBtn = document.getElementById('newChatBtn');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn'); // üî∏ nuevo
            const actionBtns = document.querySelectorAll('.action-btn');
            const modelSelectors = document.querySelectorAll('#modelSelector, #chatModelSelector');
            const authButton = document.getElementById('authButton');

            if (authButton) authButton.addEventListener('click', handleManualAuth);

            [welcomeInput, chatInput].forEach(textarea => {
                if (textarea) {
                    textarea.addEventListener('input', () => autoResize(textarea));
                    textarea.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            if (textarea === welcomeInput) handleWelcomeMessage();
                            else handleChatMessage();
                        }
                    });
                }
            });

            if (sendBtn) sendBtn.addEventListener('click', handleWelcomeMessage);
            if (chatSendBtn) chatSendBtn.addEventListener('click', handleChatMessage);
            if (newChatBtn) newChatBtn.addEventListener('click', startNewChat);
            if (clearHistoryBtn) clearHistoryBtn.addEventListener('click', clearAllHistory);

            actionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const prompt = this.getAttribute('data-prompt');
                    if (prompt && welcomeInput) {
                        welcomeInput.value = prompt;
                        welcomeInput.focus();
                        autoResize(welcomeInput);
                    }
                });
            });

            modelSelectors.forEach(selector => {
                if (selector) selector.addEventListener('click', toggleModel);
            });

            if (welcomeInput) welcomeInput.focus();
            console.log('‚úÖ Interfaz inicializada');
        }

        function updateModelDisplay() {
            const model = availableModels.find(m => m.apiName === currentModel);
            if (!model) {
                console.error("Modelo no encontrado entre los modelos disponibles:", currentModel);
                return;
            }
            document.getElementById('currentModel').textContent = model.displayName;
            document.getElementById('chatCurrentModel').textContent = model.shortName;
        }

        function toggleModel() {
            const currentIndex = availableModels.findIndex(m => m.apiName === currentModel);
            const nextIndex = (currentIndex + 1) % availableModels.length;
            currentModel = availableModels[nextIndex].apiName;
            updateModelDisplay();
            saveState();  // üî∏ guardar modelo elegido
            console.log('üîÑ Modelo cambiado a:', availableModels[nextIndex].displayName);
        }

        async function handleWelcomeMessage() {
            const welcomeInput = document.getElementById('welcomeInput');
            const message = welcomeInput.value.trim();
            if (!message || isStreaming) return;
            console.log('üì§ Enviando mensaje de bienvenida:', message);
            createNewConversation(message);
            switchToChatView();
            await sendMessage(message);
        }

        async function handleChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (!message || isStreaming) return;
            console.log('üì§ Enviando mensaje de chat:', message);
            chatInput.value = '';
            autoResize(chatInput);
            await sendMessage(message);
        }

        function createNewConversation(firstMessage) {
            currentConversationId = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const title = firstMessage.length > 50 ? firstMessage.substring(0, 50) + '...' : firstMessage;
            const conversation = {
                id: currentConversationId,
                title: title,
                messages: [],
                timestamp: new Date(),
                model: currentModel
            };
            recentConversations.unshift(conversation);
            if (recentConversations.length > 10) {
                recentConversations = recentConversations.slice(0, 10);
            }
            updateRecentItems();
            console.log('üìù Nueva conversaci√≥n creada:', title);

            saveState(); // üî∏ guardar despu√©s de crear
        }

        function updateRecentItems() {
            const recentItemsContainer = document.getElementById('recentItems');
            recentItemsContainer.innerHTML = '';

            if (!recentConversations || recentConversations.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = '<span style="color: #666; font-size: 13px; font-style: italic;">No hay conversaciones recientes</span>';
                recentItemsContainer.appendChild(emptyDiv);
                return;
            }

            recentConversations.forEach((conversation, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'recent-item';

                // T√≠tulo que abre la conversaci√≥n
                const titleSpan = document.createElement('span');
                titleSpan.className = 'recent-item-title';
                titleSpan.textContent = conversation.title;
                titleSpan.addEventListener('click', () => loadConversation(conversation.id));

                // Bot√≥n de borrar solo esta conversaci√≥n
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'recent-item-delete';
                deleteBtn.textContent = 'üóë';
                deleteBtn.title = 'Borrar esta conversaci√≥n';

                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // que no se dispare el click del t√≠tulo

                    // Quitar del array
                    recentConversations.splice(index, 1);

                    // Si era la conversaci√≥n que estaba abierta, reseteamos vista
                    if (currentConversationId === conversation.id) {
                        chatHistory = [];
                        currentConversationId = null;

                        const chatMessages = document.getElementById('chatMessages');
                        if (chatMessages) chatMessages.innerHTML = '';

                        const welcomeScreen = document.getElementById('welcomeScreen');
                        const chatContainer = document.getElementById('chatContainer');
                        if (welcomeScreen) welcomeScreen.style.display = 'flex';
                        if (chatContainer) chatContainer.classList.remove('active');
                    }

                    saveState();      // guardamos en localStorage
                    updateRecentItems(); // redibujamos lista
                });

                itemDiv.appendChild(titleSpan);
                itemDiv.appendChild(deleteBtn);
                recentItemsContainer.appendChild(itemDiv);
            });
        }

        function loadConversation(conversationId) {
            const conversation = recentConversations.find(conv => conv.id === conversationId);
            if (!conversation) return;
            currentConversationId = conversationId;
            chatHistory = [...conversation.messages];
            currentModel = conversation.model;
            updateModelDisplay();
            switchToChatView();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            conversation.messages.forEach(msg => {
                addMessage(msg.content, msg.role);
            });
            document.getElementById('chatInput').focus();
            console.log('üìÇ Conversaci√≥n cargada:', conversation.title);
            saveState(); // üî∏ guardar conversaci√≥n activa
        }

        function switchToChatView() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('chatContainer').classList.add('active');
            console.log('üîÑ Cambi√≥ a la vista de chat');
        }

        function startNewChat() {
            chatHistory = [];
            currentConversationId = null;
            
            // --- BUG FIX: Reset model to default on new chat ---
            currentModel = availableModels[0].apiName;
            updateModelDisplay();
            
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatContainer = document.getElementById('chatContainer');
            const chatMessages = document.getElementById('chatMessages');
            const welcomeInput = document.getElementById('welcomeInput');
            
            if (welcomeScreen) welcomeScreen.style.display = 'flex';
            if (chatContainer) chatContainer.classList.remove('active');
            if (chatMessages) chatMessages.innerHTML = '';
            if (welcomeInput) {
                welcomeInput.value = '';
                autoResize(welcomeInput);
                welcomeInput.focus();
            }
            autoResize(document.getElementById('chatInput'));
            
            console.log('üÜï Se inici√≥ un nuevo chat, el modelo se restableci√≥ al valor predeterminado.');
            saveState(); // üî∏ guardar estado vac√≠o / nuevo
        }

        function clearAllHistory() {
            if (!confirm('¬øSeguro que quieres borrar todas las conversaciones? Esta acci√≥n no se puede deshacer.')) return;

            chatHistory = [];
            recentConversations = [];
            currentConversationId = null;

            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) chatMessages.innerHTML = '';

            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatContainer = document.getElementById('chatContainer');
            if (welcomeScreen) welcomeScreen.style.display = 'flex';
            if (chatContainer) chatContainer.classList.remove('active');

            updateRecentItems();
            saveState();
        }

        async function sendMessage(message) {
            if (isStreaming) return;
            
            console.log('üöÄ Empezando a enviar mensaje...');
            addMessage(message, 'user');
            showTypingIndicator();
            setInputState(false);

            chatHistory.push({ role: 'user', content: message });
            
            try {
                isStreaming = true;
                if (typeof puter === 'undefined') {
                    throw new Error('Puter.js no est√° disponible.');
                }

                console.log('üì° Llamando a Puter AI con el modelo:', currentModel);

                // Enviamos solo las √∫ltimas 20 entradas para no pasarnos de contexto
                const historyForApi = chatHistory.slice(-20);

                const completion = await puter.ai.chat(historyForApi, {
                    model: currentModel,
                    stream: false   // üî¥ IMPORTANTE: sin streaming
                });

                hideTypingIndicator();

                const { messageContent } = addMessage('', 'assistant');
                let fullResponse = '';

                // Formato t√≠pico de Puter para Claude
                if (completion?.message?.content) {
                    if (Array.isArray(completion.message.content)) {
                        fullResponse = completion.message.content
                            .map(part => (typeof part === 'string' ? part : (part.text || '')))
                            .join('');
                    } else if (typeof completion.message.content === 'string') {
                        fullResponse = completion.message.content;
                    }
                } else if (completion?.text) {
                    fullResponse = completion.text;
                } else {
                    fullResponse = JSON.stringify(completion);
                }

                console.log('‚úÖ Respuesta completa recibida.');
                renderFormattedMessage(fullResponse, messageContent);

                chatHistory.push({ role: 'assistant', content: fullResponse });
               updateCurrentConversation();

            } catch (error) {
                console.error('‚ùå Error en sendMessage:', error);
                hideTypingIndicator();
                addMessage(
                   'Lo siento, encontr√© un error al hablar con Puter: ' +
                    (error && error.message ? error.message : 'Error desconocido.'),
                    'assistant',
                    true
                );

                // quitamos el √∫ltimo mensaje de usuario si la llamada fall√≥
                if (chatHistory.length > 0 && chatHistory[chatHistory.length - 1].role === 'user') {
                    chatHistory.pop();
                }
            } finally {
                isStreaming = false;
                setInputState(true);
               document.getElementById('chatInput')?.focus();
            }
        }

        function updateCurrentConversation() {
            if (!currentConversationId) return;
            const conversation = recentConversations.find(conv => conv.id === currentConversationId);
            if (conversation) {
                conversation.messages = [...chatHistory];
                conversation.timestamp = new Date();
                conversation.model = currentModel;
                const index = recentConversations.indexOf(conversation);
                if (index > 0) {
                    recentConversations.splice(index, 1);
                    recentConversations.unshift(conversation);
                }
                updateRecentItems();
                saveState(); // üî∏ guardar siempre que cambie
            }
        }

        function addMessage(content, role, isError = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.setAttribute('data-message-id', messageId);
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = role === 'user' ? 'H' : `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (role === 'assistant') renderFormattedMessage(content, messageContent);
            else messageContent.textContent = content;
            
            if (isError) messageContent.style.color = '#ff6b6b';
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            scrollToBottom();
            return { messageId, messageContent };
        }
        
        function renderFormattedMessage(content, container) {
            container.innerHTML = ''; // Borrar contenido anterior
            const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
            let lastIndex = 0;
            let match;

            while ((match = codeBlockRegex.exec(content)) !== null) {
                if (match.index > lastIndex) {
                    const textPart = document.createElement('div');
                    textPart.className = 'message-text-part';
                    textPart.textContent = content.substring(lastIndex, match.index);
                    container.appendChild(textPart);
                }

                const [fullMatch, language, code] = match;
                container.appendChild(createArtifactCanvas(code.trim(), language || 'text'));
                lastIndex = match.index + fullMatch.length;
            }

            if (lastIndex < content.length) {
                 const textPart = document.createElement('div');
                textPart.className = 'message-text-part';
                textPart.textContent = content.substring(lastIndex);
                container.appendChild(textPart);
            }
            
            if (container.children.length === 0 && content) {
                 const textPart = document.createElement('div');
                textPart.className = 'message-text-part';
                textPart.textContent = content;
                container.appendChild(textPart);
            }
        }

        function createArtifactCanvas(code, language) {
            const canvas = document.createElement('div');
            canvas.className = 'artifact-canvas';

            const header = document.createElement('div');
            header.className = 'artifact-header';
            
            const title = document.createElement('div');
            title.className = 'artifact-title';
            title.textContent = language ? `${language} code` : 'Code Artifact';
            
            const actions = document.createElement('div');
            actions.className = 'artifact-actions';

            if (language.toLowerCase() === 'html') {
                const viewBtn = document.createElement('button');
                viewBtn.className = 'artifact-btn view-btn';
                viewBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> View`;
                viewBtn.onclick = () => {
                    const blob = new Blob([code], { type: 'text/html' });
                    window.open(URL.createObjectURL(blob), '_blank');
                };
                actions.appendChild(viewBtn);
            }
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'artifact-btn';
            const copyIcon = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Copy`;
            copyBtn.innerHTML = copyIcon;
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(code).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.innerHTML = copyIcon; }, 2000);
                });
            };

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'artifact-btn';
            downloadBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Download`;
            downloadBtn.onclick = () => {
                const extensionMap = { javascript: 'js', python: 'py', html: 'html', css: 'css', json: 'json', java: 'java', csharp: 'cs', cpp: 'cpp', ruby: 'rb', go: 'go', rust: 'rs', shell: 'sh', bash: 'sh' };
                const extension = extensionMap[language.toLowerCase()] || 'txt';
                const filename = `claude-code.${extension}`;
                const blob = new Blob([code], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                a.remove();
            };

            actions.appendChild(copyBtn);
            actions.appendChild(downloadBtn);
            header.appendChild(title);
            header.appendChild(actions);

            const codeArea = document.createElement('div');
            codeArea.className = 'artifact-code';
            const pre = document.createElement('pre');
            const codeEl = document.createElement('code');
            codeEl.textContent = code;
            pre.appendChild(codeEl);
            codeArea.appendChild(pre);

            canvas.appendChild(header);
            canvas.appendChild(codeArea);

            return canvas;
        }

        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'flex';
                scrollToBottom();
            }
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function setInputState(enabled) {
            const inputs = [
                document.getElementById('welcomeInput'),
                document.getElementById('chatInput'),
                document.getElementById('sendBtn'),
                document.getElementById('chatSendBtn')
            ];
            inputs.forEach(input => {
                if (input) {
                    input.disabled = !enabled;
                    input.style.opacity = enabled ? '1' : '0.6';
                }
            });
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                requestAnimationFrame(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }
        }

        function autoResize(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
    </script>
</body>
</html>
